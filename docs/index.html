<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canada Tech Ecosystem Map</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.ico">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 320px;
            --primary-color: #2563eb;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --bg-secondary: #f8fafc;
            --border-color: #e2e8f0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Syles */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.05);
        }

        .header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: white;
        }

        .header h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .filters {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Inputs & Controls */
        input[type="text"],
        select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.875rem;
            color: var(--text-primary);
            background: white;
            transition: border-color 0.15s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .checkbox-item input {
            accent-color: var(--primary-color);
            cursor: pointer;
        }

        .footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .stats-bar {
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Map Styles */
        #map {
            flex: 1;
            background: #f0f0f0;
        }

        /* Company Sidebar Styles */
        .company-sidebar {
            width: var(--sidebar-width);
            background: white;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .company-count {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .company-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .company-card {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .company-card:hover {
            background-color: var(--bg-secondary);
        }

        .company-card:active {
            background-color: #e2e8f0;
        }

        .company-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            display: block;
        }

        .company-location {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            display: block;
        }

        .company-industry {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: inline-block;
            background: var(--bg-secondary);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        /* Custom Popup Styles */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .leaflet-popup-content {
            margin: 16px;
            font-family: 'Inter', sans-serif;
        }

        .popup-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            display: block;
            color: var(--text-primary);
        }

        .popup-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: block;
        }

        .popup-link {
            display: inline-block;
            margin-top: 8px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .popup-link:hover {
            text-decoration: underline;
        }

        /* Province Tooltip */
        .province-tooltip {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 40vh;
                order: 2;
            }

            #map {
                height: 60vh;
                order: 1;
            }

            .company-sidebar {
                width: 100%;
                height: 40vh;
                order: 3;
            }
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="header">
            <h1>ðŸ‡¨ðŸ‡¦ Canada Tech</h1>
            <p>Discover tech companies, startups, and hubs across the country.</p>
        </div>

        <div class="stats-bar" id="stats">
            Loading...
        </div>

        <div class="filters">
            <!-- Search -->
            <div class="filter-group">
                <label class="filter-label">Search</label>
                <input type="text" id="search-input" placeholder="Company name or keyword...">
            </div>

            <!-- Industry -->
            <div class="filter-group">
                <label class="filter-label">Industry</label>
                <select id="industry-select">
                    <option value="">All Industries</option>
                    <!-- Populated via JS -->
                </select>
            </div>

            <!-- Remote Policy -->
            <div class="filter-group">
                <label class="filter-label">Remote Policy</label>
                <div class="checkbox-group" id="policy-filters">
                    <!-- Populated via JS -->
                </div>
            </div>

            <!-- Province -->
            <div class="filter-group">
                <label class="filter-label">Province</label>
                <select id="province-select">
                    <option value="">All Provinces</option>
                    <!-- Populated via JS -->
                </select>
            </div>
        </div>

        <div class="footer">
            Data sourced from community contributions.
        </div>
    </aside>

    <div id="map"></div>

    <aside class="company-sidebar">
        <div class="sidebar-header">
            <h2>Companies</h2>
            <span class="company-count" id="company-count">0</span>
        </div>
        <div class="company-list" id="company-list">
            <!-- Populated via JS -->
        </div>
    </aside>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        // Initialize Map
        // Centered roughly on Canada
        const map = L.map('map', {
            zoomControl: false
        }).setView([56.1304, -106.3468], 4);

        // Move zoom control to top-right
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // CartoDB Positron Tiles (Clean, Light)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // Province color mapping
        const provinceColors = {
            'AB': '#FF6B6B', // Red
            'BC': '#4ECDC4', // Teal
            'MB': '#95E1D3', // Mint
            'NB': '#F38181', // Coral
            'NL': '#AA96DA', // Purple
            'NS': '#FCBAD3', // Pink
            'NT': '#FFD93D', // Yellow
            'NU': '#6BCB77', // Green
            'ON': '#4D96FF', // Blue
            'PE': '#FF9F43', // Orange
            'QC': '#A8E6CF', // Light Green
            'SK': '#FFD89B', // Peach
            'YT': '#C7CEEA'  // Lavender
        };

        // State
        let allCompanies = [];
        let markers = L.layerGroup().addTo(map);
        let provinceLayer = null;
        let markerMap = new Map(); // Map company ID to marker for quick lookup
        let filters = {
            search: '',
            industry: '',
            province: '',
            policies: [] // Set of checked policies
        };

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const industrySelect = document.getElementById('industry-select');
        const provinceSelect = document.getElementById('province-select');
        const policyContainer = document.getElementById('policy-filters');
        const statsDiv = document.getElementById('stats');
        const companyListDiv = document.getElementById('company-list');
        const companyCountSpan = document.getElementById('company-count');

        // Load Province Boundaries
        async function loadProvinceBoundaries() {
            // Try multiple GeoJSON sources
            const sources = [
                'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/canada.geojson',
                'https://raw.githubusercontent.com/codeforgermany/click_that_hood/main/public/data/canada.geojson'
            ];
            
            for (const sourceUrl of sources) {
                try {
                    const response = await fetch(sourceUrl);
                    
                    if (!response.ok) {
                        continue; // Try next source
                    }
                    
                    const geojson = await response.json();
                    
                    provinceLayer = L.geoJSON(geojson, {
                        style: function(feature) {
                            // Get province code/name from feature properties (try multiple common property names)
                            const props = feature.properties || {};
                            const provName = (props.name || props.NAME || props.PRENAME || props.province || '').toString();
                            const provCode = (props.code || props.CODE || props.PRUID || '').toString();
                            
                            // Try to match province code
                            let color = '#E0E0E0'; // Default gray
                            
                            // First try direct code match
                            if (provCode && provinceColors[provCode.toUpperCase()]) {
                                color = provinceColors[provCode.toUpperCase()];
                            } else {
                                // Try matching by name
                                const upperName = provName.toUpperCase();
                                for (const [code, provColor] of Object.entries(provinceColors)) {
                                    const fullName = getProvinceName(code).toUpperCase();
                                    if (upperName.includes(code) || upperName.includes(fullName) || 
                                        fullName.includes(upperName) || upperName.includes(code)) {
                                        color = provColor;
                                        break;
                                    }
                                }
                            }
                            
                            return {
                                fillColor: color,
                                fillOpacity: 0.25,
                                color: '#888',
                                weight: 1.5,
                                opacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const props = feature.properties || {};
                            const provName = props.name || props.NAME || 'Province';
                            
                            // Add tooltip
                            layer.bindTooltip(provName, {
                                permanent: false,
                                direction: 'center',
                                className: 'province-tooltip'
                            });
                            
                            // Add hover effect
                            layer.on({
                                mouseover: function(e) {
                                    const layer = e.target;
                                    layer.setStyle({
                                        fillOpacity: 0.5,
                                        weight: 2.5,
                                        color: '#333'
                                    });
                                },
                                mouseout: function(e) {
                                    if (provinceLayer) {
                                        provinceLayer.resetStyle(e.target);
                                    }
                                }
                            });
                        }
                    }).addTo(map);
                    
                    // Markers are already added to map, so they'll appear on top
                    // No need to call bringToFront - Leaflet handles z-index automatically
                    return; // Success, exit function
                } catch (err) {
                    console.warn(`Failed to load province boundaries from ${sourceUrl}:`, err);
                    continue; // Try next source
                }
            }
            
            // If all sources failed, just log a warning - map will still work without province boundaries
            console.warn("Could not load province boundaries from any source. Map will work without province coloring.");
        }
        
        // Helper function to get province name from code
        function getProvinceName(code) {
            const names = {
                'AB': 'Alberta',
                'BC': 'British Columbia',
                'MB': 'Manitoba',
                'NB': 'New Brunswick',
                'NL': 'Newfoundland',
                'NS': 'Nova Scotia',
                'NT': 'Northwest Territories',
                'NU': 'Nunavut',
                'ON': 'Ontario',
                'PE': 'Prince Edward Island',
                'QC': 'Quebec',
                'SK': 'Saskatchewan',
                'YT': 'Yukon'
            };
            return names[code] || '';
        }

        // Fetch and Initialize Data
        async function init() {
            // Load province boundaries first
            await loadProvinceBoundaries();
            
            try {
                const response = await fetch(`companies.csv?v=${Date.now()}`);
                const text = await response.text();

                Papa.parse(text, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        allCompanies = results.data.filter(c => c.id && c.lat && c.lng);
                        setupFilters();
                        renderMarkers();
                    }
                });
            } catch (err) {
                console.error("Failed to load data", err);
                statsDiv.textContent = "Error loading data.";
            }
        }

        // Setup Dynmaic Filters based on data
        function setupFilters() {
            // Get unique Industries
            const industries = [...new Set(allCompanies.map(c => c.industry).filter(Boolean))].sort();
            industries.forEach(ind => {
                const option = document.createElement('option');
                option.value = ind;
                option.textContent = ind;
                industrySelect.appendChild(option);
            });

            // Get unique Provinces
            const provinces = [...new Set(allCompanies.map(c => c.province).filter(Boolean))].sort();
            provinces.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov;
                option.textContent = prov;
                provinceSelect.appendChild(option);
            });

            // Get unique Remote Policies
            const policies = [...new Set(allCompanies.map(c => c.remote_policy).filter(Boolean))].sort();
            // Default select all policies
            filters.policies = [...policies];

            policies.forEach(policy => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = policy;
                input.checked = true;

                // Add event listener
                input.addEventListener('change', (e) => {
                    const val = e.target.value;
                    if (e.target.checked) {
                        filters.policies.push(val);
                    } else {
                        filters.policies = filters.policies.filter(p => p !== val);
                    }
                    renderMarkers();
                });

                label.appendChild(input);
                label.appendChild(document.createTextNode(policy));
                policyContainer.appendChild(label);
            });

            // Add other listeners
            searchInput.addEventListener('input', (e) => {
                filters.search = e.target.value.toLowerCase();
                renderMarkers();
            });

            industrySelect.addEventListener('change', (e) => {
                filters.industry = e.target.value;
                renderMarkers();
            });

            provinceSelect.addEventListener('change', (e) => {
                filters.province = e.target.value;
                renderMarkers();
            });
        }

        // Main Render Logic
        function renderMarkers() {
            markers.clearLayers();
            markerMap.clear();

            const filtered = allCompanies.filter(company => {
                // Search Filter (Name or Description)
                const searchMatch = !filters.search ||
                    (company.name && company.name.toLowerCase().includes(filters.search)) ||
                    (company.description && company.description.toLowerCase().includes(filters.search));

                // Dropdown Filters
                const industryMatch = !filters.industry || company.industry === filters.industry;
                const provinceMatch = !filters.province || company.province === filters.province;

                // Checkbox Filter
                const policyMatch = filters.policies.includes(company.remote_policy);

                return searchMatch && industryMatch && provinceMatch && policyMatch;
            });

            // Update Stats
            statsDiv.textContent = `${filtered.length} Companies`;

            // Draw Markers with province-based colors
            filtered.forEach(company => {
                // Use province color for marker, fallback to primary blue
                const markerColor = provinceColors[company.province] || '#2563eb';
                
                const marker = L.circleMarker([company.lat, company.lng], {
                    radius: 8,
                    fillColor: markerColor,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                })
                    .addTo(markers)
                    .bindPopup(`
                    <span class="popup-title">${company.name}</span>
                    <span class="popup-meta">${company.industry} â€¢ ${company.city}, ${company.province}</span>
                    <span class="popup-meta">${company.remote_policy}</span>
                    <p style="margin: 8px 0; font-size: 0.9em; line-height: 1.4;">${company.description || ''}</p>
                    <a href="${company.url}" target="_blank" class="popup-link">Visit Website &rarr;</a>
                `);
                
                // Store marker reference for company list interaction
                markerMap.set(company.id, marker);
            });
            
            // Render company list
            renderCompanyList(filtered);
            
            // Markers are added after province layer, so they automatically appear on top
            // Leaflet handles z-index based on layer order
        }

        // Render Company List
        function renderCompanyList(filteredCompanies) {
            // Update count
            companyCountSpan.textContent = filteredCompanies.length;

            // Clear existing list
            companyListDiv.innerHTML = '';

            // Sort companies alphabetically by name
            const sorted = [...filteredCompanies].sort((a, b) => {
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });

            // Create company cards
            sorted.forEach(company => {
                const card = document.createElement('div');
                card.className = 'company-card';
                card.innerHTML = `
                    <span class="company-name">${company.name || 'Unnamed Company'}</span>
                    <span class="company-location">${company.city || ''}${company.city && company.province ? ', ' : ''}${company.province || ''}</span>
                    ${company.industry ? `<span class="company-industry">${company.industry}</span>` : ''}
                `;

                // Add click handler to pan map and open popup
                card.addEventListener('click', () => {
                    const marker = markerMap.get(company.id);
                    if (marker) {
                        map.setView([company.lat, company.lng], Math.max(map.getZoom(), 10), {
                            animate: true,
                            duration: 0.5
                        });
                        marker.openPopup();
                    }
                });

                companyListDiv.appendChild(card);
            });
        }

        // Start
        init();

    </script>
</body>

</html>